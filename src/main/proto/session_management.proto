syntax = "proto3";

package quickfixj.management.v1;

option java_multiple_files = true;
option java_package = "com.quickfixj.management.v1";

service SessionManagementService {
  // Runtime: Called by the QFJ instance on startup to register itself
  rpc RegisterInstance (InstanceRegistrationRequest) returns (InstanceRegistrationResponse);

  // Runtime: Streams updates (New Session Added, Session Disabled, etc.) to the instance
  rpc SubscribeToSessionUpdates (InstanceId) returns (stream SessionUpdateEvent);

  // Portal/Runtime: Get all sessions assigned to a specific instance
  rpc GetInstanceSessions (InstanceId) returns (SessionList);

  // Portal: CRUD operations for Sessions
  rpc CreateSession (CreateSessionRequest) returns (SessionConfig);
  rpc UpdateSession (UpdateSessionRequest) returns (SessionConfig);
  rpc DeleteSession (SessionId) returns (google.protobuf.Empty);
}

message InstanceId {
  string id = 1; // Unique ID of the running container/server
}

message InstanceRegistrationRequest {
  string hostname = 1;
  string ip_address = 2;
  string instance_group = 3; // e.g., "PROD-EQUITIES", "UAT-DERIVATIVES"
}

message InstanceRegistrationResponse {
  string assigned_instance_id = 1;
  SessionList initial_sessions = 2;
}

message SessionConfig {
  string session_id = 1; // Internal DB ID
  
  // Standard FIX Session ID tuple
  string begin_string = 2; // FIX.4.2, FIX.4.4, etc.
  string sender_comp_id = 3;
  string target_comp_id = 4;
  string session_qualifier = 5;

  // Connection details
  string connection_type = 6; // acceptor or initiator
  string host = 7;
  int32 port = 8;
  
  // Dynamic settings
  bool enabled = 9;
  map<string, string> additional_settings = 10; // HeartBtInt, StartTime, EndTime, etc.
}

message SessionList {
  repeated SessionConfig sessions = 1;
}

message SessionUpdateEvent {
  enum EventType {
    SESSION_ADDED = 0;
    SESSION_MODIFIED = 1;
    SESSION_REMOVED = 2;
    STOP_SESSION = 3;
    START_SESSION = 4;
  }
  EventType type = 1;
  SessionConfig config = 2;
}

// ... Create/Update request messages would mirror SessionConfig fields